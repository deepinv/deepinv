
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="robots" content="noindex">

    <title>deepinv.sampling.diffusion_sde &#8212; deepinv 0.3.7 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=9112d68a" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=29d04658"></script>
    <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=35a8b989"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-NSEKFKYSGR"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-NSEKFKYSGR');
            </script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/deepinv/sampling/diffusion_sde';</script>
    <link rel="canonical" href="https://deepinv.github.io/deepinv/_modules/deepinv/sampling/diffusion_sde.html" />
    <link rel="icon" href="../../../_static/logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">ðŸŽ‰ We are part of the <a href='https://landscape.pytorch.org/?item=modeling--computer-vision--deepinverse' target='_blank'> official PyTorch ecosystem!</a><br>ðŸ“§ <a href='https://forms.gle/TFyT7M2HAWkJYfvQ7' target='_blank'> Join our mailing list</a> for releases and updates.</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/deepinv_logolarge.png" class="logo__image only-light" alt="deepinv 0.3.7 documentation - Home"/>
    <img src="../../../_static/logo_large_dark.png" class="logo__image only-dark pst-js-only" alt="deepinv 0.3.7 documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../quickstart.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../auto_examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user_guide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../API.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../finding_help.html">
    Finding Help
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../contributing.html">
    Contributing to DeepInverse
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../community.html">
    Community
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../changelog.html">
    Change Log
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../quickstart.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../auto_examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user_guide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../API.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../finding_help.html">
    Finding Help
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../contributing.html">
    Contributing to DeepInverse
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../community.html">
    Community
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../changelog.html">
    Change Log
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">deepinv.sampling.diffusion_sde</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for deepinv.sampling.diffusion_sde</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">deepinv.physics</span><span class="w"> </span><span class="kn">import</span> <span class="n">Physics</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">deepinv.models.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Reconstructor</span><span class="p">,</span> <span class="n">Denoiser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">deepinv.optim.data_fidelity</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZeroFidelity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">deepinv.sampling.sde_solver</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSDESolver</span><span class="p">,</span> <span class="n">SDEOutput</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">deepinv.sampling.noisy_datafidelity</span><span class="w"> </span><span class="kn">import</span> <span class="n">NoisyDataFidelity</span><span class="p">,</span> <span class="n">DPSDataFidelity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">deepinv.sampling.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">trapz_torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">deepinv.models.wrapper</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinusOneOneDenoiserWrapper</span>


<div class="viewcode-block" id="BaseSDE">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.BaseSDE.html#deepinv.sampling.BaseSDE">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseSDE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for Stochastic Differential Equation (SDE):</span>

<span class="sd">    .. math::</span>
<span class="sd">        d x_{t} = f(x_t, t) dt + g(t) d w_{t}</span>

<span class="sd">    where :math:`f` is the drift term, :math:`g` is the diffusion coefficient and :math:`w` is the standard Brownian motion.</span>
<span class="sd">    It defines the common interface for drift and diffusion functions.</span>

<span class="sd">    :param Callable drift: a time-dependent drift function :math:`f(x, t)`</span>
<span class="sd">    :param Callable diffusion: a time-dependent diffusion function :math:`g(t)`</span>
<span class="sd">    :param deepinv.sampling.BaseSDESolver solver: the solver for solving the SDE.</span>
<span class="sd">    :param torch.dtype dtype: the data type of the computations.</span>
<span class="sd">    :param torch.device device: the device for the computations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">drift</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">diffusion</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">solver</span><span class="p">:</span> <span class="n">BaseSDESolver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift</span> <span class="o">=</span> <span class="n">drift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diffusion</span> <span class="o">=</span> <span class="n">diffusion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

<div class="viewcode-block" id="BaseSDE.sample">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.BaseSDE.html#deepinv.sampling.BaseSDE.sample">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_init</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">get_trajectory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SDEOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the SDE with the given timesteps.</span>

<span class="sd">        :param torch.Tensor x_init: initial value.</span>
<span class="sd">        :param int seed: the seed for the pseudo-random number generator used in the solver.</span>
<span class="sd">        :param bool get_trajectory: whether to return the full trajectory of the SDE or only the last sample, optional. Default to False</span>
<span class="sd">        :param \*args: additional arguments for the solver.</span>
<span class="sd">        :param \*\*kwargs: additional keyword arguments for the solver.</span>

<span class="sd">        :return : the generated sample (:class:`torch.Tensor` of shape `(B, C, H, W)`) if `get_trajectory` is `False`. Otherwise, returns (:class:`torch.Tensor`, :class:`torch.Tensor`) of shape `(B, C, H, W)` and `(N, B, C, H, W)` where `N` is the number of steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">rng_manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_init</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">)):</span>
            <span class="n">x_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_init</span><span class="p">(</span><span class="n">x_init</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">x_init</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">get_trajectory</span><span class="o">=</span><span class="n">get_trajectory</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">get_trajectory</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">solution</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">solution</span><span class="o">.</span><span class="n">trajectory</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">solution</span><span class="o">.</span><span class="n">sample</span></div>


<div class="viewcode-block" id="BaseSDE.discretize">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.BaseSDE.html#deepinv.sampling.BaseSDE.discretize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">discretize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discretize the SDE at the given time step.</span>

<span class="sd">        :param torch.Tensor x: current state.</span>
<span class="sd">        :param float t: discretized time step.</span>
<span class="sd">        :param \*args: additional arguments for the drift.</span>
<span class="sd">        :param \*\*kwargs: additional keyword arguments for the drift.</span>

<span class="sd">        :return tuple[Tensor, Tensor]: discretized drift and diffusion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffusion</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseSDE.sample_init">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.BaseSDE.html#deepinv.sampling.BaseSDE.sample_init">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample_init</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample from the end-time distribution of the forward diffusion.</span>

<span class="sd">        :param shape: The shape of the the sample, of the form `(B, C, H, W)`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="BaseSDE.forward">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.BaseSDE.html#deepinv.sampling.BaseSDE.forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_init</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">get_trajectory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SDEOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The forward function corresponds to SDE sampling.</span>

<span class="sd">        :param torch.Tensor x_init: initial value.</span>
<span class="sd">        :param int seed: the seed for the pseudo-random number generator used in the solver.</span>
<span class="sd">        :param bool get_trajectory: whether to return the full trajectory of the SDE or only the last sample, optional. Default to False</span>
<span class="sd">        :param \*args: additional arguments for the solver.</span>
<span class="sd">        :param \*\*kwargs: additional keyword arguments for the solver.</span>

<span class="sd">        :return: the generated sample (:class:`torch.Tensor` of shape `(B, C, H, W)`) if `get_trajectory` is `False`. Otherwise, returns (:class:`torch.Tensor`, :class:`torch.Tensor`) of shape `(B, C, H, W)` and `(N, B, C, H, W)` where `N` is the number of steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">x_init</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">get_trajectory</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DiffusionSDE">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.DiffusionSDE.html#deepinv.sampling.DiffusionSDE">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DiffusionSDE</span><span class="p">(</span><span class="n">BaseSDE</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define the Reverse-time Diffusion Stochastic Differential Equation.</span>

<span class="sd">    Given a forward-time SDE of the form:</span>

<span class="sd">    .. math::</span>
<span class="sd">        d x_t = f(x_t, t) dt + g(t)d w_t</span>

<span class="sd">    This class define the following reverse-time SDE:</span>

<span class="sd">    .. math::</span>
<span class="sd">        d x_{t} = \left( f(x_t, t) - \frac{1 + \alpha(t)}{2} g(t)^2 \nabla \log p_t(x_t) \right) dt + g(t) \sqrt{\alpha(t)} d w_{t}.</span>

<span class="sd">    :param Callable drift: a time-dependent drift function :math:`f(x, t)` of the forward-time SDE.</span>
<span class="sd">    :param Callable diffusion: a time-dependent diffusion function :math:`g(t)` of the forward-time SDE.</span>
<span class="sd">    :param Callable, float alpha: a (possibly time-dependent) positive scalar weighting the diffusion term. A  constant function :math:`\alpha(t) = 0` corresponds to ODE sampling and :math:`\alpha(t) &gt; 0` corresponds to SDE sampling.</span>
<span class="sd">    :param deepinv.models.Denoiser: a denoiser used to provide an approximation of the score at time :math:`t` :math:`\nabla \log p_t`.</span>
<span class="sd">    :param deepinv.sampling.BaseSDESolver solver: the solver for solving the SDE.</span>
<span class="sd">    :param bool minus_one_one: If `True`, wrap the denoiser so that SDE states `x` in [-1, 1] are converted to [0, 1] before denoising and mapped back afterward.</span>
<span class="sd">        Set `True` for denoisers trained on [0, 1] (all denoisers in :class:`deepinv.models.Denoiser`);</span>
<span class="sd">        set `False` only if the denoiser natively expects [-1, 1].</span>
<span class="sd">        This affects only the denoiser interface and usually improves quality when matched to the denoiser&#39;s training range.</span>
<span class="sd">        Default: `True`.</span>
<span class="sd">    :param torch.dtype dtype: data type of the computation, except for the ``denoiser`` which will use ``torch.float32``.</span>
<span class="sd">        We recommend using `torch.float64` for better stability and less numerical error when solving the SDE in discrete time, since</span>
<span class="sd">        most computation cost is from evaluating the ``denoiser``, which will be always computed in ``torch.float32``.</span>
<span class="sd">    :param torch.device device: device on which the computation is performed.</span>
<span class="sd">    :param \*args: additional arguments for the :class:`deepinv.sampling.BaseSDE`.</span>
<span class="sd">    :param \*\*kwargs: additional keyword arguments for the :class:`deepinv.sampling.BaseSDE`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">forward_drift</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">forward_diffusion</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">denoiser</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">solver</span><span class="p">:</span> <span class="n">BaseSDESolver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">minus_one_one</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Callable</span><span class="p">):</span>
            <span class="n">alpha_value</span> <span class="o">=</span> <span class="n">alpha</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">alpha</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">alpha_value</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">backward_drift</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">forward_drift</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">forward_diffusion</span><span class="p">(</span>
                <span class="n">t</span>
            <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">backward_diffusion</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">alpha</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">forward_diffusion</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">drift</span><span class="o">=</span><span class="n">backward_drift</span><span class="p">,</span>
            <span class="n">diffusion</span><span class="o">=</span><span class="n">backward_diffusion</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_drift</span> <span class="o">=</span> <span class="n">forward_drift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_diffusion</span> <span class="o">=</span> <span class="n">forward_diffusion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">denoiser</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">denoiser</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">minus_one_one</span> <span class="k">else</span> <span class="n">MinusOneOneDenoiserWrapper</span><span class="p">(</span><span class="n">denoiser</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minus_one_one</span> <span class="o">=</span> <span class="n">minus_one_one</span>

<div class="viewcode-block" id="DiffusionSDE.score">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.DiffusionSDE.html#deepinv.sampling.DiffusionSDE.score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Approximating the score function :math:`\nabla \log p_t` by the denoiser.</span>

<span class="sd">        :param torch.Tensor x: current state</span>
<span class="sd">        :param torch.Tensor, float t: current time step</span>
<span class="sd">        :param \*args: additional arguments for the `denoiser`.</span>
<span class="sd">        :param \*\*kwargs: additional keyword arguments for the `denoiser`, e.g., `class_labels` for class-conditional models.</span>

<span class="sd">        :return: the score function :math:`\nabla \log p_t(x)`.</span>
<span class="sd">        :rtype: torch.Tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span>

<div class="viewcode-block" id="DiffusionSDE.sigma_t">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.DiffusionSDE.html#deepinv.sampling.DiffusionSDE.sigma_t">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sigma_t</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The :math:`\sigma(t)` of the condition distribution :math:`p(x_t \vert x_0) \sim \mathcal{N}(s(t)x_0, s(t)^2 \sigma_t^2 \mathrm{Id})`.</span>

<span class="sd">        :param torch.Tensor, float t: current time step</span>

<span class="sd">        :return: the noise level at time step `t`.</span>
<span class="sd">        :rtype: torch.Tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="DiffusionSDE.scale_t">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.DiffusionSDE.html#deepinv.sampling.DiffusionSDE.scale_t">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">scale_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The scale :math:`s(t)` of the condition distribution :math:`p(x_t \vert x_0) \sim \mathcal{N}(s(t)x_0, s(t)^2 \sigma_t^2 \mathrm{Id})`.</span>

<span class="sd">        :param torch.Tensor, float t: current time step</span>

<span class="sd">        :return: the mean of the condition distribution at time step `t`.</span>
<span class="sd">        :rtype: torch.Tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
</div>



<div class="viewcode-block" id="EDMDiffusionSDE">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.EDMDiffusionSDE.html#deepinv.sampling.EDMDiffusionSDE">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EDMDiffusionSDE</span><span class="p">(</span><span class="n">DiffusionSDE</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generative diffusion Stochastic Differential Equation.</span>

<span class="sd">    This class implements the diffusion generative SDE based on the formulation from :footcite:t:`karras2022elucidating` (with :math:`\beta(t) = \alpha(t) s(t)^2 \sigma(t) \sigma&#39;(t)`):</span>

<span class="sd">    .. math::</span>
<span class="sd">        d x_t = \left(\frac{s&#39;(t)}{s(t)} x_t - (1 + \alpha(t)) s(t)^2 \sigma(t) \sigma&#39;(t) \nabla \log p_t(x_t) \right) dt + s(t) \sqrt{2 \alpha(t) \sigma(t) \sigma&#39;(t)} d w_t</span>

<span class="sd">    where :math:`s(t)` is a time-dependent scale, :math:`\sigma(t)` is a time-dependent noise level, and :math:`\alpha(t)` is weighting the diffusion term.</span>
<span class="sd">    It corresponds to the reverse-time SDE of the following forward-time SDE:</span>

<span class="sd">    .. math::</span>
<span class="sd">        d x_t = \frac{s&#39;(t)}{s(t)} x_t dt + s(t) \sqrt{2 \sigma(t) \sigma&#39;(t)} d w_t</span>

<span class="sd">    The scale :math:`s(t)` and noise :math:`\sigma(t)` schedulers must satisfy :math:`s(0) = 1`, :math:`\sigma(0) = 0` and :math:`\lim_{t \to \infty} \sigma(t) = +\infty`.</span>


<span class="sd">    Common choices include the variance-preserving formulation :math:`s(t) = \left(1 + \sigma(t)^2\right)^{-1/2}` and the variance-exploding formulation :math:`s(t) = 1`.</span>

<span class="sd">        - For choosing variance-preserving formulation, set `variance_preserving=True` and do not provide `scale_t` and `scale_prime_t`.</span>
<span class="sd">        - For choosing variance-exploding formulation, set `variance_exploding=True` and do not provide `scale_t` and `scale_prime_t`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This SDE must be solved by going reverse in time i.e. from :math:`t=T` to :math:`t=0`.</span>

<span class="sd">    :param Callable sigma_t: a time-dependent noise level schedule.</span>
<span class="sd">        It takes a time step `t` (either a Python ``float`` or a ``torch.Tensor``) as input  and returns the noise level at time `t` (either a Python ``float`` or a ``torch.Tensor``).</span>
<span class="sd">        Note that this is a required argument.</span>
<span class="sd">    :param Callable scale_t: a time-dependent scale schedule.</span>
<span class="sd">        It takes a time step `t` (either a Python ``float`` or a ``torch.Tensor``) as input  and returns the noise level at time `t` (either a Python ``float`` or a ``torch.Tensor``).</span>
<span class="sd">        If not provided, it will be set to :math:`s(t) = \left(1 + \sigma(t)^2\right)^{-1/2}` if `variance_preserving=True`, or :math:`s(t) = 1` if `variance_exploding=True`.</span>
<span class="sd">        If both `variance_preserving` and `variance_exploding` are `False`, `scale_t` must be provided. Default to `None`.</span>
<span class="sd">    :param Callable sigma_prime_t: the derivative of `sigma_t`.</span>
<span class="sd">        It takes a time step `t` (either a Python ``float`` or a ``torch.Tensor``) as input and returns the noise level at time `t` (either a Python ``float`` or a ``torch.Tensor``).</span>
<span class="sd">        If not provided, it will be computed using autograd. Default to `None`.</span>
<span class="sd">    :param Callable scale_prime_t: the derivative of `scale_t`.</span>
<span class="sd">        It takes a time step `t` (either a Python ``float`` or a ``torch.Tensor``) as input and returns the noise level at time `t` (either a Python ``float`` or a ``torch.Tensor``).</span>
<span class="sd">        If not provided, it will be computed using autograd. Default to `None`.</span>
<span class="sd">    :param bool variance_preserving: whether to use a variance-preserving diffusion schedule, which imposes :math:`s(t) = \left(1 + \sigma(t)^2\right)^{-1/2}`. Default to `False`.</span>
<span class="sd">    :param bool variance_exploding: whether to use a variance-exploding diffusion schedule, which imposes :math:`s(t) = 1`. Default to `False`.</span>
<span class="sd">    :param Callable, float alpha: a (possibly time-dependent) positive scalar weighting the diffusion term. A  constant function :math:`\alpha(t) = 0` corresponds to ODE sampling and :math:`\alpha(t) &gt; 0` corresponds to SDE sampling.</span>
<span class="sd">    :param float T: the end time of the forward SDE. Default to `1.0`.</span>
<span class="sd">    :param deepinv.models.Denoiser denoiser: a denoiser used to provide an approximation of the score at time :math:`t`: :math:`\nabla \log p_t`. Default to `None`.</span>
<span class="sd">    :param deepinv.sampling.BaseSDESolver solver: the solver for solving the SDE. Default to `None`.</span>
<span class="sd">    :param torch.dtype dtype: data type of the computation, except for the ``denoiser`` which will use ``torch.float32``.</span>
<span class="sd">        We recommend using `torch.float64` for better stability and less numerical error when solving the SDE in discrete time, since</span>
<span class="sd">        most computation cost is from evaluating the ``denoiser``, which will be always computed in ``torch.float32``.</span>
<span class="sd">    :param torch.device device: device on which the computation is performed. Default to CPU.</span>
<span class="sd">    :param \*args: additional arguments for the :class:`deepinv.sampling.DiffusionSDE`.</span>
<span class="sd">    :param \*\*kwargs: additional keyword arguments for the :class:`deepinv.sampling.DiffusionSDE`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sigma_t</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">scale_t</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sigma_prime_t</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scale_prime_t</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">variance_preserving</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">variance_exploding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">denoiser</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">solver</span><span class="p">:</span> <span class="n">BaseSDESolver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>

        <span class="n">_sigma_t</span> <span class="o">=</span> <span class="n">sigma_t</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_t</span> <span class="o">=</span> <span class="n">sigma_t</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">variance_preserving</span> <span class="ow">and</span> <span class="n">variance_exploding</span>
        <span class="p">),</span> <span class="s2">&quot;Cannot set both variance_preserving and variance_exploding to True.&quot;</span>

        <span class="k">if</span> <span class="n">scale_t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">variance_preserving</span><span class="p">:</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">scale_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span>
                        <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">**</span> <span class="mf">1.5</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="n">variance_exploding</span><span class="p">:</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">scale_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;scale_t&#39; must be provided if &#39;variance_preserving&#39; and &#39;variance_exploding&#39; is False&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_scale_t</span> <span class="o">=</span> <span class="n">scale_t</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">_scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale_t</span> <span class="o">=</span> <span class="n">scale_t</span>

        <span class="k">if</span> <span class="n">sigma_prime_t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">sigma_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">enable_grad</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span>
                        <span class="n">sigma</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">t</span><span class="p">,</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">grad</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">_sigma_prime_t</span> <span class="o">=</span> <span class="n">sigma_prime_t</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">sigma_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">_sigma_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_prime_t</span> <span class="o">=</span> <span class="n">sigma_prime_t</span>

        <span class="k">if</span> <span class="n">scale_prime_t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">scale_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">enable_grad</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span>
                        <span class="n">scale</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">t</span><span class="p">,</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">grad</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">_scale_prime_t</span> <span class="o">=</span> <span class="n">scale_prime_t</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">scale_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">_scale_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale_prime_t</span> <span class="o">=</span> <span class="n">scale_prime_t</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">forward_drift</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">scale_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">*</span> <span class="n">x</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">forward_diffusion</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">forward_drift</span><span class="o">=</span><span class="n">forward_drift</span><span class="p">,</span>
            <span class="n">forward_diffusion</span><span class="o">=</span><span class="n">forward_diffusion</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">denoiser</span><span class="o">=</span><span class="n">denoiser</span><span class="p">,</span>
            <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">*</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="EDMDiffusionSDE.score">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.EDMDiffusionSDE.html#deepinv.sampling.EDMDiffusionSDE.score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Approximating the score function :math:`\nabla \log p_t` by the denoiser.</span>

<span class="sd">        :param torch.Tensor x: current state</span>
<span class="sd">        :param torch.Tensor, float t: current time step</span>
<span class="sd">        :param \*args: additional arguments for the `denoiser`.</span>
<span class="sd">        :param \*\*kwargs: additional keyword arguments for the `denoiser`, e.g., `class_labels` for class-conditional models.</span>

<span class="sd">        :return: the score function :math:`\nabla \log p_t(x)`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">x_in</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">scale</span>
        <span class="n">model_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">denoiser</span><span class="p">(</span>
            <span class="n">x_in</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">sigma</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_from_model_output</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_score_from_model_output</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">model_output</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="n">denoised</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">model_output</span>
        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">denoised</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">score</span>

<div class="viewcode-block" id="EDMDiffusionSDE.sample_init">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.EDMDiffusionSDE.html#deepinv.sampling.EDMDiffusionSDE.sample_init">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample from the initial distribution of the reverse-time diffusion SDE, which is a Gaussian with zero mean and covariance matrix :math:` s(T)^2 \sigma(T)^2 \operatorname{Id}`.</span>

<span class="sd">        :param tuple shape: The shape of the sample to generate</span>
<span class="sd">        :param torch.Generator rng: Random number generator for reproducibility</span>
<span class="sd">        :return: A sample from the prior distribution</span>
<span class="sd">        :rtype: torch.Tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">init</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_t</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_t</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">init</span></div>
</div>



<div class="viewcode-block" id="SongDiffusionSDE">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.SongDiffusionSDE.html#deepinv.sampling.SongDiffusionSDE">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SongDiffusionSDE</span><span class="p">(</span><span class="n">EDMDiffusionSDE</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generative diffusion Stochastic Differential Equation.</span>

<span class="sd">    This class implements the diffusion generative SDE based the formulation from :footcite:t:`song2020score`:</span>

<span class="sd">    .. math::</span>
<span class="sd">        d x_t = -\left(\frac{1}{2} \beta(t) x_t + \frac{1 + \alpha(t)}{2} \xi(t) \nabla \log p_t(x_t) \right) dt + \sqrt{\alpha(t) \xi(t)} d w_t</span>

<span class="sd">    where :math:`\beta(t)` is a time-dependent linear drift, :math:`\xi(t)` is a time-dependent linear diffusion, and</span>
<span class="sd">    :math:`\alpha(t)` is weighting the diffusion term.</span>

<span class="sd">    It corresponds to the reverse-time SDE of the following forward-time SDE:</span>

<span class="sd">    .. math::</span>
<span class="sd">        d x_t = -\frac{1}{2} \beta(t) x_t dt + \sqrt{\xi(t)} d w_t</span>

<span class="sd">    Compared to the EDM formulation in :class:`deepinv.sampling.EDMDiffusionSDE`, the scale :math:`s(t)` and noise :math:`\sigma(t)` schedulers are defined with respect to :math:`\beta(t)` and :math:`\xi(t)` as follows:</span>

<span class="sd">    .. math::</span>
<span class="sd">        s(t) = \exp\left(-\int_0^t \beta(s) ds\right), \quad \sigma(t) = \sqrt{2 \int_0^t \frac{\xi(s)}{s(s)^2} ds}.</span>

<span class="sd">    Common choices include the variance-preserving formulation :math:`\beta(t) = \xi(t)` and the variance-exploding formulation :math:`\beta(t) = 0`.</span>

<span class="sd">        - For choosing variance-preserving formulation, set `variance_preserving=True` and `beta_t` and `xi_t` will be automatically set to be the same function.</span>
<span class="sd">        - For choosing variance-exploding formulation, set `variance_exploding=True` and `beta_t` will be automatically set to `0`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This SDE must be solved going reverse in time i.e. from :math:`t=T` to :math:`t=0`.</span>

<span class="sd">    :param Callable beta_t: a time-dependent linear drift of the forward-time SDE.</span>
<span class="sd">    :param Callable B_t: time integral of beta_t between 0 and t. If None, it is calculated by numerical integration.</span>
<span class="sd">    :param Callable xi_t: a time-dependent linear diffusion of the forward-time SDE.</span>
<span class="sd">    :param deepinv.models.Denoiser denoiser: a denoiser used to provide an approximation of the score at time :math:`t`: :math:`\nabla \log p_t`.</span>
<span class="sd">    :param Callable, float alpha: a (possibly time-dependent) positive scalar weighting the diffusion term. A  constant function :math:`\alpha(t) = 0` corresponds to ODE sampling and :math:`\alpha(t) &gt; 0` corresponds to SDE sampling.</span>
<span class="sd">    :param float T: the end time of the forward SDE.</span>
<span class="sd">    :param deepinv.sampling.BaseSDESolver solver: the solver for solving the SDE.</span>
<span class="sd">    :param torch.dtype dtype: data type of the computation, except for the ``denoiser`` which will use ``torch.float32``.</span>
<span class="sd">        We recommend using `torch.float64` for better stability and less numerical error when solving the SDE in discrete time, since</span>
<span class="sd">        most computation cost is from evaluating the ``denoiser``, which will be always computed in ``torch.float32``.</span>
<span class="sd">    :param torch.device device: device on which the computation is performed.</span>
<span class="sd">    :param \*args: additional arguments for the :class:`deepinv.sampling.DiffusionSDE`.</span>
<span class="sd">    :param \*\*kwargs: additional keyword arguments for the :class:`deepinv.sampling.DiffusionSDE`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">beta_t</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">B_t</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">xi_t</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">variance_preserving</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">variance_exploding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">denoiser</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">solver</span><span class="p">:</span> <span class="n">BaseSDESolver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">variance_preserving</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">beta_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xi_t</span> <span class="o">=</span> <span class="n">beta_t</span>
            <span class="k">elif</span> <span class="n">xi_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">beta_t</span> <span class="o">=</span> <span class="n">xi_t</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Either beta_t or xi_t must be provided if variance_preserving is True&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">variance_exploding</span><span class="p">:</span>
            <span class="n">beta_t</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="mi">0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">B_t</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="mi">0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">B_t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">B_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">trapz_torch</span><span class="p">(</span>
                    <span class="n">beta_t</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">n_steps</span>
                <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">B_t</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">scale_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">beta_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">variance_preserving</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">integrand</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">xi_t</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">scale_t</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">integral</span> <span class="o">=</span> <span class="n">trapz_torch</span><span class="p">(</span>
                    <span class="n">integrand</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">n_steps</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">integral</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">sigma_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">xi_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sigma_t</span><span class="o">=</span><span class="n">sigma_t</span><span class="p">,</span>
            <span class="n">sigma_prime_t</span><span class="o">=</span><span class="n">sigma_prime_t</span><span class="p">,</span>
            <span class="n">scale_t</span><span class="o">=</span><span class="n">scale_t</span><span class="p">,</span>
            <span class="n">scale_prime_t</span><span class="o">=</span><span class="n">scale_prime_t</span><span class="p">,</span>
            <span class="n">variance_preserving</span><span class="o">=</span><span class="n">variance_preserving</span><span class="p">,</span>
            <span class="n">variance_exploding</span><span class="o">=</span><span class="n">variance_exploding</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
            <span class="n">denoiser</span><span class="o">=</span><span class="n">denoiser</span><span class="p">,</span>
            <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">*</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="FlowMatching">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.FlowMatching.html#deepinv.sampling.FlowMatching">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FlowMatching</span><span class="p">(</span><span class="n">EDMDiffusionSDE</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generative Flow Matching process.</span>

<span class="sd">    It corresponds to the reverse-time SDE of the following forward-time noising process, which corresponds to a linear interpolation between data and Gaussian noise:</span>

<span class="sd">    .. math::</span>
<span class="sd">        x_t = a_t x_0 + b_t z \quad \mbox{ where } x_0 \sim p_{data}  \mbox{ and } z \sim \mathcal{N}(0, I)</span>

<span class="sd">    The schedulers :math:`a(t)` and :math:`b(t)` must satisfy :math:`a(0) = 1`, :math:`b(0) = 0`, :math:`a(1) = 0`, and :math:`b(1) = 1`.</span>

<span class="sd">    Compared to the EDM formulation in :class:`deepinv.sampling.EDMDiffusionSDE`, the scale :math:`s(t)` and noise :math:`\sigma(t)` schedulers are defined with respect to :math:`a(t)` and :math:`b(t)` as follows:</span>

<span class="sd">    .. math::</span>
<span class="sd">        s(t) = a(t), \quad \sigma(t) = \frac{b(t)}{a(t)} .</span>

<span class="sd">    .. note::</span>

<span class="sd">        This SDE must be solved going reverse in time i.e. from :math:`t=1` to :math:`t=0`.</span>
<span class="sd">        Note that in order to unify flow matching and diffusion models, we set the starting time of the generating process (noise distribution) to be 1, and the ending time of the generating process (data distribution) to be 0, which is different from the convention in the flow matching literature.</span>


<span class="sd">    :param Callable a_t: time-dependent parameter :math:`a(t)` of flow-matching. Default to `lambda t: 1-t`.</span>
<span class="sd">    :param Callable a_prime_t: time derivative :math:`a&#39;(t)` of :math:`a(t)`. Default to `lambda t: -1`.</span>
<span class="sd">    :param Callable b_t: time-dependent parameter :math:`b(t)` of flow-matching.Default to `lambda t: t`.</span>
<span class="sd">    :param Callable b_prime_t: time derivative :math:`b&#39;(t)` of :math:`b(t)`. Default to `lambda t: 1`.</span>
<span class="sd">    :param deepinv.models.Denoiser denoiser: a denoiser used to provide an approximation of the score at time :math:`t`: :math:`\nabla \log p_t`.</span>
<span class="sd">    :param Callable, float alpha: a (possibly time-dependent) positive scalar weighting the diffusion term. A  constant function :math:`\alpha(t) = 0` corresponds to ODE sampling and :math:`\alpha(t) &gt; 0` corresponds to SDE sampling.</span>
<span class="sd">    :param deepinv.sampling.BaseSDESolver solver: the solver for solving the SDE.</span>
<span class="sd">    :param torch.dtype dtype: data type of the computation, except for the ``denoiser`` which will use ``torch.float32``.</span>
<span class="sd">        We recommend using `torch.float64` for better stability and less numerical error when solving the SDE in discrete time, since</span>
<span class="sd">        most computation cost is from evaluating the ``denoiser``, which will be always computed in ``torch.float32``.</span>
<span class="sd">    :param torch.device device: device on which the computation is performed.</span>
<span class="sd">    :param \*args: additional arguments for the :class:`deepinv.sampling.DiffusionSDE`.</span>
<span class="sd">    :param \*\*kwargs: additional keyword arguments for the :class:`deepinv.sampling.DiffusionSDE`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">a_t</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span>
        <span class="n">a_prime_t</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">b_t</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
        <span class="n">b_prime_t</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">denoiser</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">solver</span><span class="p">:</span> <span class="n">BaseSDESolver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">a_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">scale_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">a_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">b_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">a_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">sigma_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">b_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">b_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">a_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">scale_t</span><span class="o">=</span><span class="n">scale_t</span><span class="p">,</span>
            <span class="n">scale_prime_t</span><span class="o">=</span><span class="n">scale_prime_t</span><span class="p">,</span>
            <span class="n">sigma_t</span><span class="o">=</span><span class="n">sigma_t</span><span class="p">,</span>
            <span class="n">sigma_prime_t</span><span class="o">=</span><span class="n">sigma_prime_t</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
            <span class="n">denoiser</span><span class="o">=</span><span class="n">denoiser</span><span class="p">,</span>
            <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="FlowMatching.velocity">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.FlowMatching.html#deepinv.sampling.FlowMatching.velocity">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the velocity field of the flow matching process, which is defined as the drift of the backward SDE.</span>

<span class="sd">        :param torch.Tensor x: current state</span>
<span class="sd">        :param torch.Tensor, float t: current timestep</span>
<span class="sd">        :param \*args: additional arguments for the `denoiser`.</span>
<span class="sd">        :param \*\*kwargs: additional keyword arguments for the `denoiser`, e.g., `class_labels` for class-conditional models.</span>

<span class="sd">        :return: the velocity field at state `x` and time `t`.</span>
<span class="sd">        :rtype: torch.Tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="VarianceExplodingDiffusion">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.VarianceExplodingDiffusion.html#deepinv.sampling.VarianceExplodingDiffusion">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VarianceExplodingDiffusion</span><span class="p">(</span><span class="n">EDMDiffusionSDE</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">denoiser</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sigma_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
        <span class="n">sigma_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">solver</span><span class="p">:</span> <span class="n">BaseSDESolver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sigma_min</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma_max</span> <span class="o">/</span> <span class="n">sigma_min</span><span class="p">)</span> <span class="o">**</span> <span class="n">t</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">sigma_prime_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sigma_max</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sigma_min</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sigma_t</span><span class="o">=</span><span class="n">sigma_t</span><span class="p">,</span>
            <span class="n">sigma_prime_t</span><span class="o">=</span><span class="n">sigma_prime_t</span><span class="p">,</span>
            <span class="n">variance_exploding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">T</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">denoiser</span><span class="o">=</span><span class="n">denoiser</span><span class="p">,</span>
            <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="VariancePreservingDiffusion">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.VariancePreservingDiffusion.html#deepinv.sampling.VariancePreservingDiffusion">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VariancePreservingDiffusion</span><span class="p">(</span><span class="n">SongDiffusionSDE</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Variance-Preserving Stochastic Differential Equation (VP-SDE).</span>

<span class="sd">    This class implements the reverse-time SDE of the Variance-Preserving SDE (VP-SDE) :footcite:t:`song2020score`.</span>

<span class="sd">    The forward-time SDE is defined as follows:</span>

<span class="sd">    .. math::</span>
<span class="sd">        d x_t = -\frac{1}{2} \beta(t) x_t dt + \sqrt{\beta(t)} d w_t \quad \mbox{ where } \beta(t) = \beta_{\mathrm{min}}  + t \left( \beta_{\mathrm{max}} - \beta_{\mathrm{min}} \right)</span>

<span class="sd">    The reverse-time SDE is defined as follows:</span>

<span class="sd">    .. math::</span>
<span class="sd">        d x_t = -\left(\frac{1}{2} \beta(t) x_t + \frac{1 + \alpha(t)}{2} \beta(t) \nabla \log p_t(x_t) \right) dt + \sqrt{\alpha(t) \beta(t)} d w_t</span>

<span class="sd">    where :math:`\alpha(t)` is weighting the diffusion term.</span>

<span class="sd">    This class is the reverse-time SDE of the VP-SDE, serving as the generation process.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This SDE must be solved going reverse in time i.e. from :math:`t=T` to :math:`t=0`.</span>

<span class="sd">    :param deepinv.models.Denoiser denoiser: a denoiser used to provide an approximation of the score at time :math:`t`: :math:`\nabla \log p_t`.</span>
<span class="sd">    :param float beta_min: the minimum noise level.</span>
<span class="sd">    :param float beta_max: the maximum noise level.</span>
<span class="sd">    :param Callable, float alpha: a (possibly time-dependent) positive scalar weighting the diffusion term. A  constant function :math:`\alpha(t) = 0` corresponds to ODE sampling and :math:`\alpha(t) &gt; 0` corresponds to SDE sampling.</span>
<span class="sd">    :param bool scaled_linear: whether to use the scaled linear beta schedule. If `False`, uses the more standard linear schedule. Default to `False`.</span>
<span class="sd">    :param deepinv.sampling.BaseSDESolver solver: the solver for solving the SDE.</span>
<span class="sd">    :param torch.dtype dtype: data type of the computation, except for the ``denoiser`` which will use ``torch.float32``.</span>
<span class="sd">        We recommend using `torch.float64` for better stability and less numerical error when solving the SDE in discrete time, since</span>
<span class="sd">        most computation cost is from evaluating the ``denoiser``, which will be always computed in ``torch.float32``.</span>
<span class="sd">    :param torch.device device: device on which the computation is performed.</span>
<span class="sd">    :param \*args: additional arguments for the :class:`deepinv.sampling.DiffusionSDE`.</span>
<span class="sd">    :param \*\*kwargs: additional keyword arguments for the :class:`deepinv.sampling.DiffusionSDE`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">denoiser</span><span class="p">:</span> <span class="n">Denoiser</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beta_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">beta_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20.0</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">scaled_linear</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">solver</span><span class="p">:</span> <span class="n">BaseSDESolver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">beta_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">scaled_linear</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">beta_min</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta_max</span> <span class="o">-</span> <span class="n">beta_min</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">beta_min_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta_min</span><span class="p">)</span>
                <span class="n">beta_max_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta_max</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">beta_min_sqrt</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta_max_sqrt</span> <span class="o">-</span> <span class="n">beta_min_sqrt</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">B_t</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">scaled_linear</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">beta_min</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">t</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta_max</span> <span class="o">-</span> <span class="n">beta_min</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">beta_min_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta_min</span><span class="p">)</span>
                <span class="n">beta_max_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta_max</span><span class="p">)</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">beta_min_sqrt</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">beta_max_sqrt</span> <span class="o">-</span> <span class="n">beta_min_sqrt</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">t</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="o">**</span><span class="mi">3</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">beta_t</span><span class="o">=</span><span class="n">beta_t</span><span class="p">,</span>
            <span class="n">B_t</span><span class="o">=</span><span class="n">B_t</span><span class="p">,</span>
            <span class="n">variance_preserving</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">T</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">denoiser</span><span class="o">=</span><span class="n">denoiser</span><span class="p">,</span>
            <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">*</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="PosteriorDiffusion">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.PosteriorDiffusion.html#deepinv.sampling.PosteriorDiffusion">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PosteriorDiffusion</span><span class="p">(</span><span class="n">Reconstructor</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Posterior distribution sampling  for inverse problems using diffusion models by Reverse-time Stochastic Differential Equation (SDE).</span>

<span class="sd">    Consider the acquisition model:</span>

<span class="sd">    .. math::</span>
<span class="sd">        y = \noise{\forw{x}}.</span>

<span class="sd">    This class defines the reverse-time SDE for the posterior distribution :math:`p(x|y)` given the data :math:`y`:</span>

<span class="sd">    .. math::</span>
<span class="sd">        d\, x_t = \left( f(x_t, t) - \frac{1 + \alpha(t)}{2} g(t)^2 \nabla_{x_t} \log p_t(x_t | y) \right) d\,t + g(t) \sqrt{\alpha(t)} d\, w_{t}</span>

<span class="sd">    where :math:`f` is the drift term, :math:`g` is the diffusion coefficient and :math:`w` is the standard Brownian motion. The drift term and the diffusion coefficient are defined by the underlying (unconditional) forward-time SDE `sde`. The (conditional) score function :math:`\nabla_{x_t} \log p_t(x_t | y)` can be decomposed using the Bayes&#39; rule:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \nabla_{x_t} \log p_t(x_t | y) = \nabla_{x_t} \log p_t(x_t) + \nabla_{x_t} \log p_t(y | x_t).</span>

<span class="sd">    The first term is the score function of the unconditional SDE, which is typically approximated by a MMSE denoiser using the well-known Tweedie&#39;s formula, while the second term is approximated by the (noisy) data-fidelity term. We implement various data-fidelity terms in :class:`deepinv.sampling.NoisyDataFidelity`.</span>

<span class="sd">    :param deepinv.sampling.NoisyDataFidelity data_fidelity: the noisy data-fidelity term, used to approximate the score :math:`\nabla_{x_t} \log p_t(y \vert x_t)`. Default to :class:`deepinv.optim.ZeroFidelity`, which corresponds to the zero data-fidelity term and the sampling process boils down to the unconditional SDE sampling.</span>
<span class="sd">    :param deepinv.models.Denoiser denoiser: a denoiser used to provide an approximation of the (unconditional) score at time :math:`t` :math:`\nabla \log p_t`.</span>
<span class="sd">    :param deepinv.sampling.DiffusionSDE sde: the forward-time SDE, which defines the drift and diffusion terms of the reverse-time SDE.</span>
<span class="sd">    :param deepinv.sampling.BaseSDESolver solver: the solver for the SDE. If not specified, the solver from the `sde` will be used.</span>
<span class="sd">    :param torch.dtype dtype: the data type of the sampling solver, except for the ``denoiser`` which will use ``torch.float32``.</span>
<span class="sd">        We recommend using `torch.float64` for better stability and less numerical error when solving the SDE in discrete time, since most computation cost is from evaluating the ``denoiser``, which will be always computed in ``torch.float32``.</span>
<span class="sd">    :param torch.device device: the device for the computations.</span>
<span class="sd">    :param bool verbose: whether to display a progress bar during the sampling process, optional. Default to `False`.</span>
<span class="sd">    :param bool minus_one_one: If `True`, wrap the denoiser so that SDE states `x` in `[-1, 1]` are converted to `[0, 1]` before denoising and mapped back afterward.</span>

<span class="sd">        - Set `True` for denoisers trained on `[0, 1]` data range (all denoisers in :class:`deepinv.models.Denoiser`).</span>
<span class="sd">        - Set `False` only if the denoiser natively expects `[-1, 1]` data range.</span>

<span class="sd">        This affects only the denoiser interface and usually improves quality when matched to the denoiser&#39;s training range.</span>
<span class="sd">        Default: `True`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_fidelity</span><span class="p">:</span> <span class="n">NoisyDataFidelity</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">denoiser</span><span class="p">:</span> <span class="n">Denoiser</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sde</span><span class="p">:</span> <span class="n">DiffusionSDE</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">solver</span><span class="p">:</span> <span class="n">BaseSDESolver</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">minus_one_one</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">data_fidelity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_fidelity</span> <span class="o">=</span> <span class="n">ZeroFidelity</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_fidelity</span> <span class="o">=</span> <span class="n">data_fidelity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sde</span> <span class="o">=</span> <span class="n">sde</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minus_one_one</span> <span class="o">=</span> <span class="n">minus_one_one</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">denoiser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sde</span><span class="o">.</span><span class="n">denoiser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;A denoiser must be specified.&quot;</span>
        <span class="k">if</span> <span class="n">denoiser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">denoiser</span> <span class="o">=</span> <span class="n">sde</span><span class="o">.</span><span class="n">denoiser</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">denoiser</span> <span class="o">=</span> <span class="n">denoiser</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_fidelity</span><span class="p">,</span> <span class="s2">&quot;denoiser&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_fidelity</span><span class="o">.</span><span class="n">denoiser</span> <span class="o">=</span> <span class="n">denoiser</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">solver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sde</span><span class="o">.</span><span class="n">solver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;A SDE solver must be specified.&quot;</span>
        <span class="k">if</span> <span class="n">solver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">sde</span><span class="o">.</span><span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">backward_drift</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">physics</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">forward_drift</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">alpha</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">forward_diffusion</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span>
                <span class="n">y</span><span class="p">,</span> <span class="n">physics</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">backward_diffusion</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">diffusion</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="n">BaseSDE</span><span class="p">(</span>
            <span class="n">drift</span><span class="o">=</span><span class="n">backward_drift</span><span class="p">,</span>
            <span class="n">diffusion</span><span class="o">=</span><span class="n">backward_diffusion</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="PosteriorDiffusion.forward">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.PosteriorDiffusion.html#deepinv.sampling.PosteriorDiffusion.forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">physics</span><span class="p">:</span> <span class="n">Physics</span><span class="p">,</span>
        <span class="n">x_init</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timesteps</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">get_trajectory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample the posterior distribution :math:`p(x|y)` given the data measurement :math:`y`.</span>

<span class="sd">        :param torch.Tensor y: the data measurement.</span>
<span class="sd">        :param deepinv.physics.Physics physics: the forward operator.</span>
<span class="sd">        :param torch.Tensor, tuple x_init: the initial value for the sampling, can be a :class:`torch.Tensor` or a tuple `(B, C, H, W)`, indicating the shape of the initial point, matching the shape of `physics` and `y`. In this case, the initial value is taken randomly following the end-point distribution of the `sde`.</span>
<span class="sd">        :param int seed: the random seed for reproducibility, the same samples will be generated for the same seed. Default to `None`.</span>
<span class="sd">        :param torch.Tensor timesteps: the time steps for the solver. If `None`, the default time steps in the solver will be used. Default to `None`.</span>
<span class="sd">        :param bool get_trajectory: whether to return the full trajectory of the SDE or only the last sample, optional. Default to `False`.</span>
<span class="sd">        :param \*args: the additional arguments for the solver.</span>
<span class="sd">        :param \*\*kwargs: the additional keyword arguments for the solver.</span>

<span class="sd">        :return: the generated sample (:class:`torch.Tensor` of shape `(B, C, H, W)`) if `get_trajectory` is `False`. Otherwise, returns a tuple (:class:`torch.Tensor`, :class:`torch.Tensor`) of shape `(B, C, H, W)` and `(N, B, C, H, W)` where `N` is the number of steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">rng_manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_init</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">)):</span>
            <span class="n">x_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">sample_init</span><span class="p">(</span><span class="n">x_init</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">x_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">physics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">sample_init</span><span class="p">(</span>
                    <span class="n">physics</span><span class="o">.</span><span class="n">A_dagger</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">rng</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">sample_init</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either `x_init` or `physics` must be specified.&quot;</span><span class="p">)</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">,</span>
            <span class="n">x_init</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
            <span class="n">physics</span><span class="o">=</span><span class="n">physics</span><span class="p">,</span>
            <span class="n">timesteps</span><span class="o">=</span><span class="n">timesteps</span><span class="p">,</span>
            <span class="n">get_trajectory</span><span class="o">=</span><span class="n">get_trajectory</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Scale the output back to [0, 1]</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">solution</span><span class="o">.</span><span class="n">sample</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus_one_one</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">get_trajectory</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sample</span><span class="p">,</span> <span class="n">solution</span><span class="o">.</span><span class="n">trajectory</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sample</span></div>


<div class="viewcode-block" id="PosteriorDiffusion.score">
<a class="viewcode-back" href="../../../api/stubs/deepinv.sampling.PosteriorDiffusion.html#deepinv.sampling.PosteriorDiffusion.score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">physics</span><span class="p">:</span> <span class="n">Physics</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Approximating the conditional score :math:`\nabla_{x_t} \log p_t(x_t \vert y)`.</span>

<span class="sd">        :param torch.Tensor y: the data measurement.</span>
<span class="sd">        :param deepinv.physics.Physics physics: the forward operator.</span>
<span class="sd">        :param torch.Tensor x: the current state.</span>
<span class="sd">        :param torch.Tensor, float t: the current time step.</span>
<span class="sd">        :param \*args: additional arguments for the score function of the unconditional SDE.</span>
<span class="sd">        :param \*\*kwargs: additional keyword arguments for the score function of the unconditional SDE.</span>

<span class="sd">        :return: the score function :math:`\nabla_{x_t} \log p_t(x_t \vert y)`.</span>
<span class="sd">        :rtype: torch.Tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_fidelity</span><span class="p">,</span> <span class="n">ZeroFidelity</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">sigma_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">scale_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="p">,</span> <span class="n">EDMDiffusionSDE</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_fidelity</span><span class="p">,</span> <span class="n">DPSDataFidelity</span>
            <span class="p">):</span>
                <span class="c1"># For EDM, we can compute the score from model output directly, avoid redundant computation</span>
                <span class="n">data_fid_grad</span><span class="p">,</span> <span class="n">model_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_fidelity</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">scale</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">physics</span><span class="o">=</span><span class="n">physics</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">get_model_outputs</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">_score_from_model_output</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span>
                <span class="p">)</span> <span class="o">-</span> <span class="n">data_fid_grad</span> <span class="o">/</span> <span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_fidelity</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">scale</span><span class="p">),</span>
                        <span class="n">y</span><span class="p">,</span>
                        <span class="n">physics</span><span class="o">=</span><span class="n">physics</span><span class="p">,</span>
                        <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="o">/</span> <span class="n">scale</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">score</span></div>
</div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      Â© Copyright deepinverse contributors 2025.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.0.4.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>