name: Test GPU

on:
  push:
    branches:
      - "gpu-tests"

jobs:
  test:
    name: Test deep inverse GPU
    runs-on: self-hosted
    env:
      DEEPINV_MOCK_TESTS: "True"

    steps:
      - uses: actions/checkout@v3

      # ✅ Create and activate Conda environment with Python 3.11
      - name: Create Conda env (Python 3.11)
        run: |
          conda create -y -n py311 python=3.11
          source "$(conda info --base)/etc/profile.d/conda.sh"
          conda activate py311
          python --version

      - name: Install deepinv
        run: |
          source "$(conda info --base)/etc/profile.d/conda.sh"
          conda activate py311
          pip install --upgrade pip
          pip install -e .[dataset,denoisers,test,training]

      - name: Check Python version
        run: |
          source "$(conda info --base)/etc/profile.d/conda.sh"
          conda activate py311
          python --version

      - name: Check installed packages
        run: |
          source "$(conda info --base)/etc/profile.d/conda.sh"
          conda activate py311
          pip list

      - name: Check import
        run: |
          source "$(conda info --base)/etc/profile.d/conda.sh"
          conda activate py311
          python -c "import deepinv"

      - name: Test with pytest
        run: |
          source "$(conda info --base)/etc/profile.d/conda.sh"
          conda activate py311
          python -m pytest -n 2 --dist=loadgroup

      # ✅ Cleanup: remove conda env & workspace (except .git/.github)
      - name: Cleanup environment and workspace
        if: always()
        run: |
          # Remove conda env
          conda env remove -n py311 -y || true

          # Clean working directory except .git and .github
          shopt -s dotglob
          for item in *; do
            if [ "$item" != ".git" ] && [ "$item" != ".github" ]; then
              rm -rf "$item"
            fi
          done
