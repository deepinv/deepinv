name: Test GPU

on:
  schedule:
    # run test every day at 2:30 AM UTC
    - cron: "30 2 */1 * *"
  push:
    branches:
    - gpu-tests

jobs:
  test:
    name: Test and docs GPU
    runs-on: gpu
    env:
      DEEPINV_MOCK_TESTS: "True"

    steps:
      - uses: actions/checkout@v3

      # ✅ Create and activate Conda environment with Python 3.11
      - name: Create Conda env (Python 3.11)
        run: |
          conda create -y -n py311 python=3.11
          source "$(conda info --base)/etc/profile.d/conda.sh"
          conda activate py311
          python --version

      - name: Install deepinv
        run: |
          conda activate py311
          pip install --upgrade pip
          pip install -e .[dataset,denoisers,test,training]

      - name: Check Python version
        run: |
          python --version

      - name: Check installed packages
        run: |
          pip list

      - name: Check import
        run: |
          python -c "import deepinv"

      - name: Test with pytest
        run: |
          python -m pytest -n 2 --dist=loadgroup

      - name: Sphinx build
        run: |
          sphinx-build -W docs/source _build
      - name: Run doctests
        run: |
          # Get all the RST files, excluding multigpu.rst
          # and *datasets.rst files
          _doctest_files=$(find . -name '*.rst' ! -name '*multigpu.rst' ! -name '*datasets*.rst')
          # Run doctest with sphinx, to get the extra IGNORE_OUTPUT primitive
          # using plot_gallery=0 to avoid building examples
          sphinx-build -M doctest docs/source/ docs/build/ -D plot_gallery=0 -v $_doctest_files

      # ✅ Cleanup: remove conda env & workspace (except .git/.github)
      - name: Cleanup environment and workspace
        if: always()
        run: |
          # Remove conda env
          conda env remove -n py311 -y || true

          # Clean working directory except .git and .github
          shopt -s dotglob
          for item in *; do
            if [ "$item" != ".git" ] && [ "$item" != ".github" ]; then
              rm -rf "$item"
            fi
          done
